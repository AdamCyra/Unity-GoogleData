using UnityEngine;
using UnityEditor;
using System.Collections;
using System.Collections.Generic;
using System.Text;

using GDataDB;
using GDataDB.Linq;

[CustomEditor(typeof(LanguagePack))]
public class LanguagePackEditor  : BaseEditor<LanguagePack>
{
	
	public void OnEnable()
	{
		base.OnEnable();
		
		Debug.Log ("OnEnable: LanguagePackEditor");
		
		//T data = (T)target;
		LanguagePack data = database as LanguagePack;
		
		databaseFields = ExposeProperties.GetProperties(data);
		
		foreach(LanguageData e in data.dataArray)
		{
		    dataFields = ExposeProperties.GetProperties(e);
			pInfoList.Add(dataFields);
		}
	}
	
	public override void OnInspectorGUI()
	{
		base.OnInspectorGUI();
		
		//DrawDefaultInspector();
		if (GUI.changed)
		{
			pInfoList.Clear();
			
			LanguagePack data = database as LanguagePack;
			foreach(LanguageData e in data.dataArray)
			{
				dataFields = ExposeProperties.GetProperties(e);
				pInfoList.Add(dataFields);
			}
			
			EditorUtility.SetDirty(target);
			Repaint();
		}
	}
	
	public override bool Load()
	{
		var client = new DatabaseClient(username, password);		
		var db = client.GetDatabase(database.SheetName) ?? client.CreateDatabase(database.SheetName);	
		var table = db.GetTable<LanguageData>(database.WorksheetName) ?? db.CreateTable<LanguageData>(database.WorksheetName);
		
		List<LanguageData> languageDataList = new List<LanguageData>();
		
		var all = table.FindAll();						
		foreach(var elem in all)
		{
			LanguageData data = new LanguageData();
			
			data = Cloner.DeepCopy<LanguageData>(elem.Element);
			languageDataList.Add(data);
		}
		
#if UNITY_EDITOR
		Debug.Log ("=== LanguageData ===");
		foreach(var e in languageDataList)
		{
			Debug.Log ("Key: " + e.Key);
			Debug.Log ("Text: " + e.Text);
		}
#endif
		
		LanguagePack langugePack = (LanguagePack)base.database;
		langugePack.dataArray = languageDataList.ToArray();
		
		EditorUtility.SetDirty(langugePack);
		AssetDatabase.SaveAssets();
		
		return true;
	}
}
